package(default_visibility = ["//third_party/py/scenic:internal"])

licenses(["notice"])

py_library(
    name = "train_lib",
    srcs = [
        "default_trainer.py",
        "detr_trainer.py",
        "set_detection_trainer.py",
        "trainers.py",
    ],
    srcs_version = "PY3",
    deps = [
        ":train_utils",
        "//third_party/py/absl:app",
        "//third_party/py/absl/logging",
        "//third_party/py/flax",
        "//third_party/py/flax/training",
        "//third_party/py/jax",
        "//third_party/py/numpy",
        "//third_party/py/scenic/dataset_lib",
        "//third_party/py/scenic/debug_lib",
    ],
)

py_library(
    name = "train_utils",
    srcs = [
        "lr_schedules.py",
        "optimizers.py",
        "train_utils.py",
    ],
    srcs_version = "PY3",
    deps = [
        "//third_party/py/absl/logging",
        "//third_party/py/jax",
        "//third_party/py/jax:optimizers",
        "//third_party/py/scenic/debug_lib",
    ],
)

py_test(
    name = "test_default_trainer",
    size = "medium",
    srcs = [
        "test_default_trainer.py",
    ],
    python_version = "PY3",
    deps = [
        ":train_lib",
        "//third_party/py/absl/testing:absltest",
        "//third_party/py/ml_collections",
        "//third_party/py/scenic/model_lib",
        "//third_party/py/scenic/model_lib/base_models",
        "//third_party/py/tensorflow",
    ],
)

py_test(
    name = "test_set_detection_trainer",
    size = "medium",
    srcs = [
        "test_set_detection_trainer.py",
    ],
    python_version = "PY3",
    deps = [
        ":train_lib",
        "//third_party/py/absl/testing:absltest",
        "//third_party/py/ml_collections",
        "//third_party/py/scenic/model_lib",
        "//third_party/py/scenic/model_lib/base_models",
    ],
)

py_test(
    name = "test_detr_trainer",
    size = "medium",
    srcs = [
        "test_detr_trainer.py",
    ],
    python_version = "PY3",
    tags = [
        "nomsan",
        "notap",  # TODO(b/156519324): re-enable the test.
        "requires-gpu-nvidia",
    ],
    deps = [
        ":train_lib",
        "//learning/brain/research/jax:gpu_support",  # build_cleaner: keep
        "//third_party/py/absl/testing:absltest",
        "//third_party/py/ml_collections",
        "//third_party/py/scenic/model_lib",
    ],
)

py_test(
    name = "test_lr_schedules",
    size = "small",
    srcs = ["test_lr_schedules.py"],
    python_version = "PY3",
    deps = [
        ":train_utils",
        "//third_party/py/absl/testing:absltest",
        "//third_party/py/absl/testing:parameterized",
        "//third_party/py/scenic",
    ],
)
